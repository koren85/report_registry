<!-- app/views/hooks/report_registry/_show_reports.html.erb -->
<tr class="reports-section" id="issue-reports">
  <td colspan="5">
    <div class="box">
      <h3>
        <%= l(:label_reports) %>
        <% if User.current.allowed_to?(:manage_reports, @project) || User.current.admin? %>
          <%= link_to '',
                      '#',
                      class: 'icon icon-add',
                      id: 'show-report-menu',
                      title: l(:button_add) %>
        <% end %>
      </h3>

      <table class="list reports">
        <thead>
        <tr>
          <th><%= l(:field_version) %></th>
          <th><%= l(:field_report_name) %></th>
          <th><%= l(:field_report_period) %></th>
          <th><%= l(:field_date_period) %></th>
          <th></th>
        </tr>
        </thead>
        <tbody id="reports-list">
        <% if @issue.reports.any? %>
          <% @issue.reports.includes(:project, :version).order(updated_at: :desc).each do |report| %>
            <%= render partial: 'report', locals: { report: report } %>
          <% end %>
        <% else %>
          <tr class="no-reports">
            <td colspan="5" class="text-center"><%= l(:label_no_data) %></td>
          </tr>
        <% end %>
        </tbody>
      </table>
    </div>
  </td>
</tr>

<!-- Выпадающее меню для выбора отчета -->
<div id="report-menu" class="dropdown-menu" style="display: none;">
  <% available_reports = @project.reports
                                 .where("version_id IS NULL OR version_id = ?", @issue.fixed_version_id)
                                 .where.not(id: @issue.report_ids)
                                 .order(updated_at: :desc) %>
  <ul>
    <% if available_reports.any? %>
      <% available_reports.each do |report| %>
        <li>
          <%= link_to report.name,
                      add_project_issue_report_issues_path(@project, @issue),
                      class: 'add-report-link',
                      remote: true,
                      method: :post,
                      data: {
                        report_id: report.id
                      } %>
        </li>
      <% end %>
    <% else %>
      <li class="disabled"><span><%= l(:label_no_available_reports) %></span></li>
    <% end %>
  </ul>
</div>

<% content_for :header_tags do %>
  <%= javascript_include_tag 'report_menu', plugin: 'report_registry' %>
  <%= javascript_include_tag 'report_registry', plugin: 'report_registry' %>
  <%= stylesheet_link_tag 'report_registry', plugin: 'report_registry' %>
<% end %>
